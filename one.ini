function getOrCreateFolder(parent, name) {
  // nullチェック追加
  if (!name || name === "undefined" || name === "null") {
    Logger.log("エラー: フォルダ名がnullまたは空です");
    Logger.log("parent: " + parent);
    Logger.log("name: " + name);
    throw new Error("フォルダ名が空です: " + name);
  }

  const folders = parent ? parent.getFolders() : DriveApp.getFolders();
  while (folders.hasNext()) {
    const f = folders.next();
    if (f.getName() === name) return f;
  }
  return parent ? parent.createFolder(name) : DriveApp.createFolder(name);
}

function generateRewardReports() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheet = ss.getSheetByName("RewardReport");
  const data = sheet.getDataRange().getValues();
  const headerRowIndex = 5;
  const dataStartRow = 6;
  const header = data[headerRowIndex - 1].slice(0, 16);  // A〜P列（16列）

  // BA_MasterシートからBAIDとメールアドレスの対応を取得
  const masterSheet = ss.getSheetByName("BA_Master");
  const masterData = masterSheet.getDataRange().getValues();
  const emailMap = {};
  for (let i = 1; i < masterData.length; i++) {  // 1行目はヘッダーと仮定
    const baid = String(masterData[i][4]).trim();  // E列（インデックス4）
    const email = String(masterData[i][10]).trim();  // K列（インデックス10）
    if (baid && email) {
      emailMap[baid] = email;
    }
  }

  const rawMonth = sheet.getRange("B2").getValue();
  Logger.log("rawMonth の値: " + rawMonth);  // デバッグ用

  if (!rawMonth) {
    throw new Error("B2セルに対象月が入力されていません");
  }

  const targetMonth = String(rawMonth).replace(/\//g, "-").trim();  // 例: "2025-06"
  Logger.log("targetMonth の値: " + targetMonth);  // デバッグ用

  if (!targetMonth) {
    throw new Error("対象月の形式が不正です: " + rawMonth);
  }

  // ヘッダーの書式取得
  const headerRange = sheet.getRange(headerRowIndex, 1, 1, 16);
  const headerBackgrounds = headerRange.getBackgrounds()[0];
  const headerFontWeights = headerRange.getFontWeights()[0];
  const headerFontSizes = headerRange.getFontSizes()[0];
  const headerFontColors = headerRange.getFontColors()[0];

  // 列幅取得
  const columnWidths = [];
  for (let i = 1; i <= 16; i++) {
    columnWidths.push(sheet.getColumnWidth(i));
  }

  // 「MonthlyReport」フォルダを取得／作成
  Logger.log("MonthlyReportフォルダを作成します");
  const parentFolder = getOrCreateFolder(null, "MonthlyReport");
  Logger.log("MonthlyReportフォルダ作成完了");

  for (let i = dataStartRow - 1; i < data.length; i++) {
    const row = data[i];
    const name = String(row[0]).trim();
    const baid = String(row[2]).trim();
    if (!name || !baid || name === "undefined" || baid === "undefined") continue;

    const personFolderName = `${name}様_${baid}`;
    Logger.log(`処理中: ${personFolderName}`);
    Logger.log(`個人フォルダ作成: "${personFolderName}"`);
    const personFolder = getOrCreateFolder(parentFolder, personFolderName);
    Logger.log(`月フォルダ作成: "${targetMonth}"`);
    const monthFolder = getOrCreateFolder(personFolder, targetMonth);
    const fileName = `${targetMonth}_${name}様_${baid}_RewardReport`;

    // 同名ファイルがあればスキップ
    const existingFiles = monthFolder.getFilesByName(fileName);
    if (existingFiles.hasNext()) {
      Logger.log(`スキップ: ${fileName}（すでに存在）`);
      continue;
    }

    // 新しいスプレッドシート作成
    const newFile = SpreadsheetApp.create(fileName);
    const newSheet = newFile.getSheets()[0];
    newSheet.setName(fileName);

    for (let col = 0; col < 16; col++) {
      newSheet.setColumnWidth(col + 1, columnWidths[col]);
    }

    // ヘッダー書き込み
    newSheet.getRange(1, 1, 1, 16).setValues([header]);
    const newHeaderRange = newSheet.getRange(1, 1, 1, 16);
    newHeaderRange.setBackgrounds([headerBackgrounds]);
    newHeaderRange.setFontWeights([headerFontWeights]);
    newHeaderRange.setFontSizes([headerFontSizes]);
    newHeaderRange.setFontColors([headerFontColors]);

    // 個人データ書き込み
    newSheet.getRange(2, 1, 1, 16).setValues([row.slice(0, 16)]);

    // ファイルを月別フォルダに移動
    const file = DriveApp.getFileById(newFile.getId());
    monthFolder.addFile(file);
    DriveApp.getRootFolder().removeFile(file);

    // BAIDに対応するメールアドレスがあれば共有
    const email = emailMap[String(baid).trim()];
    if (email) {
      try {
        file.addEditor(email);  // 編集者として共有（閲覧者の場合は addViewer に変更）
        Logger.log(`共有完了: ${fileName} → ${email}`);
      } catch (e) {
        Logger.log(`共有エラー: ${fileName} → ${email}: ${e.message}`);
      }
    } else {
      Logger.log(`メールアドレス未登録: BAID=${baid}`);
    }
  }
}
